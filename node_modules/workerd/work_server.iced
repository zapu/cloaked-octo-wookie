http = require 'http'
formidable = require 'formidable'
url = require 'url'

CurrentWork = null
Callback = ->

server = http.createServer (request, response) ->
	if CurrentWork == null
		console.log 'Request to work server but CurrentWork is null'
		response.end()
		return

	pathname = url.parse(request.url).pathname

	if pathname == '/getWork'
		response.writeHead 200, 'Content-Type': 'application/octet-stream'
		response.end CurrentWork
	else if pathname == '/submitWork'
		form = new formidable.IncomingForm()
		await form.parse request, defer err, fields, files
		unless files['data']?
			console.log "/submitWork called with no data file"
			return Callback  null

		CurrentWork = null
		Callback files['data']
		response.end()
	else if pathname == '/submitError'
		Callback 'error'
		response.end()
	else
		console.log "Unknown request to work server #{pathname}"
		response.end()

module.exports.setWork = (work) ->
	CurrentWork = work

module.exports.wait = (cb) ->
	Callback = cb

module.exports.startServer = ->
	server.listen 8090
