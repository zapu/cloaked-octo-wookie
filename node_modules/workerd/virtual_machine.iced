fs = require 'fs'
path = require 'path'
exec = require('child_process').exec

$ = module.exports

$.VBoxManage = "\"C:\\Program Files\\Oracle\\VirtualBox\\VBoxManage.exe\""
VM_Name = 'cloaked-octo-wookie'

vm_list = (what, autocb) ->
	await exec "#{$.VBoxManage} list #{what}", defer error, stdout, stderr
	throw error if error

	results = []

	for line in stdout.split("\n")
		matches = line.match /"(.*)" \{([0-9a-f\-]*)\}/
		if matches?
			results.push
				name: matches[1]
				guid: matches[2]

	return results

import_vm = (path, name, autocb) ->
	await exec "#{$.VBoxManage} import #{path} --vsys 0 --vmname #{name}",
		defer error, stdout, stderr

	throw error if error

delete_vm = (name, autocb) ->
	await exec "#{$.VBoxManage} unregistervm #{name} --delete",
		defer error, stdout, stderr

	throw error if error

control_vm = (name, action, autocb) ->
	await exec "#{$.VBoxManage} controlvm #{name} #{action}",
		defer error, stdout, stderr

	throw error if error

start_vm = (name, autocb) ->
	await exec "#{$.VBoxManage} startvm #{name} --type headless",
		defer error, stdout, stderr

	throw error if error

poweroff_vm = (name, cb) -> control_vm name, 'poweroff', cb
reset_vm = (name, cb) -> control_vm name, 'reset', cb

list_vms = (cb) -> vm_list 'vms', cb
list_running_vms = (cb) -> vm_list 'runningvms', cb

module.exports.start = (machine_path, autocb) ->
	machine_path = "\"#{machine_path}\""

	removed = false

	# Check if there already is a machine with our reserved name
	await module.exports.cleanup defer()

	console.log "Importing VM"

	await import_vm machine_path, VM_Name, defer()

	console.log "Starting VM"

	await start_vm VM_Name, defer()

module.exports.cleanup = (autocb) ->
	await list_running_vms defer machines

	for machine in machines
		if machine.name == VM_Name
			console.log "Powering down and removing #{machine.name}"

			await poweroff_vm machine.name, defer()
			await delete_vm machine.name, defer()

			removed = true

	await list_vms defer machines

	unless removed
		for machine in machines
			if machine.name == VM_Name
				console.log "Removing #{machine.name}"

				await delete_vm machine.name, defer()