fs = require 'fs'
path = require 'path'

nt = require 'nt'
node_torrent = require 'node-torrent'

postRequest = require './postRequest'

TorrentClient = new node_torrent { logLevel: 'INFO', portRange: {start:6882, end:6882} }
DataDir = 'data'

module.exports = (appAddress, pub_key, project_id, cb) ->
	await postRequest appAddress + 'downloadProject', 
		{ pub_key, project_id }, {},
		defer error, response, body

	if error or response.statusCode != 200
		return cb error

	ProjectDir = path.join DataDir, project_id

	await fs.mkdir DataDir, defer err
	await fs.mkdir ProjectDir, defer err

	TorrentPath = path.join ProjectDir, 'a.torrent'

	await fs.writeFile TorrentPath, body, defer err
	throw err if err

	torrent = TorrentClient.addTorrent TorrentPath, ProjectDir

	torrent.on 'torrent:complete', ->
		cb null, ProjectDir

	torrent.on 'torrent:progress', (comp) ->
		console.log "Torrent progress: #{comp}"

	torrent.on 'torrent:error', (err) ->
		console.log "torrent error #{err}"

