fs = require 'fs'
path = require 'path'

nt = require 'nt'
tracker = require 'node-bittorrent-tracker'
node_torrent = require 'node-torrent'

handleDatabaseError = (res, err) ->
	console.log 'CouchDB error', err
	console.trace()
	res.writeHead 500
	res.end 'Database error'

AnnounceAddress = 'http://127.0.0.1:8081/announce'
TorrentClient = null

module.exports.initTracker = () ->
	t = new tracker.Tracker()
	tracker.http.createServer t, 8081

	TorrentClient = new node_torrent logLevel: 'DEBUG'

TorrentsReady = {}

module.exports.makeTorrentFromProgram = (db, doc, response) ->
	if doc of TorrentsReady
		response.writeHead 200, 'Content-type': 'application/x-bittorrent'
		response.end TorrentsReady[doc]
		return

	programDirPath = path.join 'fileserve', doc

	await fs.mkdir 'fileserve', defer()
	await fs.mkdir programDirPath, defer()
	fileStream = fs.createWriteStream path.join programDirPath, 'program'

	getAttachment = (cb) ->
		readStream = db.getAttachment doc, 'program', cb
		readStream.pipe fileStream

	await getAttachment defer err
	return handleDatabaseError response, err if err

	response.writeHead 200, 'Content-type': 'application/x-bittorrent'

	torrentFilePath = path.join programDirPath, 'a.torrent'

	await nt.makeWrite torrentFilePath, 
		AnnounceAddress,  programDirPath, ['program'], 
		defer err, torrent

	await fs.readFile torrentFilePath, defer err, torrentFile
	throw err if err

	response.end torrentFile

	TorrentClient.addTorrent torrentFilePath, programDirPath

	TorrentsReady[doc] = torrentFile

