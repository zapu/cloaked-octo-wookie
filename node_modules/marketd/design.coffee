module.exports =
	_id: "_design/market"
	views:
		sellers_by_pub_keys:
			map: (doc) ->
				if doc.type == 'seller'
					emit doc.pub_key, doc

		work_by_ids:
			map: (doc) ->
				if doc.type == 'work'
					emit doc._id, doc

		work_by_project_ids:
			map: (doc) ->
				if doc.type == 'work'
					emit doc.project_id, doc 

		work_by_project_ids_and_requests:
			map: (doc) ->
				if doc.type == 'work'
					doc.requests.forEach (request) ->
						emit [request.pub_key, doc.project_id], doc

		work_by_results:
			map: (doc) ->
				if doc.type == 'work'
					for result in doc.results
						emit result.node, 
							{
								work_id: doc.id
								project_id: doc.project_id
								result
							}

		projects_by_ids:
			map: (doc) ->
				if doc.type == 'project'
					emit doc._id, doc

		projects_with_participants:
			map: (doc) ->
				if doc.type == 'project'
					doc.participants.forEach (participant) ->
						emit [participant, doc._id], doc

		work_unconfirmed_by_project_ids:
			map: (doc) ->
				if doc.type == 'work'
					for result in doc.results
						if result.total_score >= 1
							return

					emit doc.project_id, doc

		calculation_correctness_per_node:
			map: (doc) ->
				if doc.type == 'work'
					for result in doc.results
						emit [doc.project_id, result.node], result.total_score - result.score

			reduce: "_sum"

		unconfirmed_result_count:
			map: (doc) ->
				if doc.type == 'work'
					for result in doc.results
						if result.total_score >= 1
							return

					emit doc.project_id, doc

			reduce: "_count"

		get_work_credits:
			map: (doc) ->
				if doc.type == 'work'
					for result in doc.results
						if result.total_score >= 1
							emit [result.node, doc.project_id], 1

			reduce: "_count"

		get_total_project_credits:
			map: (doc) ->
				if doc.type == 'work'
					for result in doc.results
						if result.total_score >= 1
							emit doc.project_id, 1

			reduce: "_count"

		get_finished_projects_count:
			map: (doc) ->
				if doc.type == 'project'
					if doc.finished_id?
						emit null, doc

			reduce: "_count"